<!DOCTYPE html>
<html>
<head>
  <title>Chat</title>
  <link rel="stylesheet" href="chat.css">
</head>
<body>
<div class="container" >
  <h2 id="friendName">Chat</h2>
  <div id="chatArea"></div>
  <div class="chatInput">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendBtn" >Send</button>
  </div>
  <div class="in">
  <button id="back" >Back to Contacts</button>
  <button  id="out">Logout</button>
  </div>
</div>
<p style="color: white; font-size: 40px; text-align: center;">Created By Nnaemeka Cyril Chukwuemeka</p>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyAygGBBR5HieXwdsL9f7M8uhaoh-mYHSuc",
    authDomain: "website-53417.firebaseapp.com",
    projectId: "website-53417",
    storageBucket: "website-53417.firebasestorage.app",
    messagingSenderId: "1049856174962",
    appId: "1:1049856174962:web:04fdd8707515fdbe6a8beb",
    measurementId: "G-WPEBYN7643"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;
let chatId;

// Get friend info from URL
const urlParams = new URLSearchParams(window.location.search);
const friendName = urlParams.get("user");
chatId = urlParams.get("chatId");

document.getElementById("friendName").innerText = `Chat with ${friendName}`;

auth.onAuthStateChanged(user => {
  if(!user){
    window.location.href = "login.html";
    return;
  }
  currentUser = user;

  const chatArea = document.getElementById("chatArea");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  // Load messages in real-time
  db.collection("chats").doc(chatId).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      chatArea.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message");
        msgDiv.classList.add(msg.sender === currentUser.uid ? "sent" : "received");
        msgDiv.innerText = msg.text;
        chatArea.appendChild(msgDiv);
      });
      chatArea.scrollTop = chatArea.scrollHeight;
    });

  // Send message
  sendBtn.addEventListener("click", async () => {
    const text = messageInput.value.trim();
    if(text === "") return;
    await db.collection("chats").doc(chatId).collection("messages").add({
      sender: currentUser.uid,
      text: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageInput.value = "";
  });

  messageInput.addEventListener("keypress", async (e)=>{
    if(e.key === "Enter") sendBtn.click();
  });

  // Back to contacts
  document.getElementById("backContacts").addEventListener("click", ()=>{
    window.location.href = "users.html";
  });

  // Logout
  document.getElementById("logout").addEventListener("click", ()=>{
    auth.signOut().then(()=>window.location.href="login.html");
  });
});
</script>
</body>
</html>